---
title: "Repeated Observations -- Second Thoughts and Considerations"
output: html_notebook
---


## Disclaimer
When teaching the topic of repeated observations in Applied Statistical Methods (ASM), the completely unbalanced dataset came to my attention only very late. This might be the reason why the replication of the `lme4::lmer()` results with `aov()` was not successful. 


## Balanced Dataset
```{r rep-obs-setup, include=FALSE}
set.seed(240506)
n_nr_animals <- 5
n_nr_rep <- 3
# body weight parameters
n_bw_mean <- 465
n_bw_sd_acc <- 11.5
n_bw_sd_win <- 1.35
```

To have an easier understanding of repeated observations, we start with a balanced dataset. At the beginning, we have a dataset of `r n_nr_animals` each having `r n_nr_rep` observations of `Body.Weight`. Such a dataset can be generated by first sampling mean body weight for each animal

```{r}
vec_mean_bw <- rnorm(n_nr_animals, mean = n_bw_mean, sd = n_bw_sd_acc)
vec_mean_bw
```

Based on these means, we add some random deviates to generate individual observations

```{r}
tbl_bw_rep <- NULL
for (i in 1:n_nr_animals){
  vec_bw_dev <- rnorm(n_nr_rep, sd = n_bw_sd_win)
  tbl_cur_obs <- tibble::tibble(Animal = rep(i, n_nr_rep),
                                Body.Weight = vec_mean_bw[i] + vec_bw_dev)
  if (is.null(tbl_bw_rep)){
    tbl_bw_rep <- tbl_cur_obs
  } else {
    tbl_bw_rep <- dplyr::bind_rows(tbl_bw_rep, tbl_cur_obs)
  }
}
tbl_bw_rep
```

Check by the following plot

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
ggplot(data = tbl_bw_rep,
       mapping = aes(x = Animal,
                     y = Body.Weight)) + 
  geom_point(aes(color = as.factor(Animal))) + 
  labs(color = "Animal")
```

### Analysis
Separate variation using the following

* Animal effect

```{r}
aov_bw_rep <- aov(Body.Weight ~ Animal, data = tbl_bw_rep)
(smry_aov_bw_rep <- summary(aov_bw_rep))
```


* Animal in error term

```{r}
aov_bw_err <- aov(Body.Weight ~ Error(Animal), data = tbl_bw_rep)
summary(aov_bw_err)
```

### Method of Moments Estimate
Estimates of variance components are defined by 

$$E(MSq_R) = \sigma_R^2$$
and

$$E(MSq_A) = \sigma_R^2 + n * \sigma_A^2 $$

From the above we get:

```{r}
n_msq_res <- smry_aov_bw_rep[[1]]["Residuals", "Mean Sq"]
```


$$\widehat{\sigma_R^2} =  `r n_msq_res`$$

```{r}
n_msq_ani <- smry_aov_bw_rep[[1]]["Animal", "Mean Sq"]
n_sigma_a_hat <- (n_msq_ani - n_msq_res) / n_nr_rep
```

$$\widehat{\sigma_A^2} = \frac{E(MSq_A) - \widehat{\sigma_R^2}}{n} = `r n_sigma_a_hat`$$


